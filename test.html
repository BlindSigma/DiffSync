<!doctype html>
<html>
    <head>
        <title>Realtime collaboration test</title>
        <script src="OTClient.js" type="text/javascript"></script>
        <script type="text/javascript">

            window.onload = function(event) {
                console.log("Load!");
                var host = window.document.location.host.replace(/:.*/, "");
                console.log("ws:", host);
                var ws = new WebSocket("ws://" + host + ":5667");

                var client;

                ws.onmessage = function(event) {
                    var message = JSON.parse(event.data);

                    console.log("Received message:", message);

                    switch(message.type) {
                        case "content":
                            if (!client) {
                                client = new ClientSession(message.content);
                                console.log("Created client session");

                                client.on("patch", function(patches) {
                                    ws.send(JSON.stringify({
                                        type: "patch",
                                        patches: patches
                                    }));
                                });

                                document.getElementById("editable").value = client.getContent();

                                break;
                            }

                            break;
                        case "patch":
                            if (!client) break;
                            client.patchClient(message.patches);

                            document.getElementById("editable").value = client.getContent();

                            break;
                        default:
                            console.error("Unrecognized message");
                            break;
                    }
                };

                document.getElementById("editable").onkeyup = function updateField() {
                    if (!client) return;
                    client.edit(document.getElementById("editable").value);
                }

            }.bind(window);

        </script>
    </head>
    <body>
        <textarea id="editable">

        </textarea>
    </body>
</html>
