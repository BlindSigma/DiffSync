<!doctype html>
<html>
    <head>
        <title>Realtime collaboration test</title>
        <script src="OTClient.js" type="text/javascript"/>
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", function(event) {
                var host = window.document.location.host.replace(/:.*/, '');
                var ws = new WebSocket("ws://" + host + ":5667");

                var client;

                ws.onMessage = function(event) {
                    console.log("Received message:", event);

                    var message = JSON.parse(event.data);

                    switch(message.type) {
                        case "content":
                            if (!client) {
                                client = new ClientSession(message.content);

                                client.on("patch", function(patches) {
                                    ws.send(JSON.stringify({
                                        type: "patch",
                                        patches: patches
                                    }));
                                });

                                break;
                            }

                            client.setContent(message.content);
                            break;
                        case "patch":
                            if (!client) break;
                            client.patchClient(message.patches);

                            document.getElementById("editable").value = client.getContent();

                            break;
                        default:
                            console.error("Unrecognized message");
                            break;
                    }
                };

                function updateField() {
                    if (!client) return;
                    client.edit(document.getElementById("editable").value);
                }

            });
        </script>
    </head>
    <body>
        <textarea id="editable" onChange="updateField" onkeyup="updateField">

        </textarea>
    </body>
</html>
